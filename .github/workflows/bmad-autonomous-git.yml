name: BMAD Autonomous Git Workflow

on:
  push:
    branches: [ master, main, bmad-auto-* ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # Run every 30 minutes during work hours (UTC)
    - cron: '*/30 9-17 * * 1-5'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync with remote'
        required: false
        default: 'false'

jobs:
  auto-git:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.name "BMAD Auto-Git Bot"
        git config --global user.email "bmad-auto-git@noreply.github.com"
    
    - name: Check repository status
      run: |
        echo "Current branch: $(git branch --show-current)"
        echo "Dirty files: $(git status --porcelain | wc -l)"
        echo "Last commit: $(git log --oneline -1)"
    
    - name: Run BMAD Autonomous Git
      run: |
        chmod +x tools/bmad-autonomous-git.sh
        ./tools/bmad-autonomous-git.sh
    
    - name: Create PR if on feature branch
      if: startsWith(github.ref, 'refs/heads/bmad-auto-')
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "🤖 BMAD Auto-Generated Changes"
        body: |
          ## 🚀 BMAD v6 Autonomous Git Workflow
          
          This PR was automatically generated by the BMAD v6 Autonomous Git Workflow system.
          
          ### 📊 Changes Summary
          - ✅ Micro-commits for better change tracking
          - 🔄 Automatic conflict resolution where possible
          - 🛡️ Continuous integration to prevent massive conflicts
          - 📝 Each commit represents a logical unit of change
          
          ### 🔍 Review Guidelines
          - Each commit is limited to max 10 files for clarity
          - Conflicts have been auto-resolved using safe strategies
          - Manual review recommended for complex business logic changes
          - Documentation and configuration changes are auto-approved
          
          ### 🎯 BMAD Methodology Applied
          - **Scale-Adaptive**: Appropriate commit size based on change volume
          - **Continuous Integration**: Prevents accumulation of conflicts
          - **Automated Quality**: Consistent commit messages and structure
          
          ---
          *Generated by BMAD v6 Autonomous Git System*
        branch: ${{ github.ref }}
        base: master
        labels: |
          bmad-auto
          automated-pr
          micro-commits
    
    - name: Auto-merge safe changes
      if: |
        startsWith(github.ref, 'refs/heads/bmad-auto-') && 
        (contains(github.event.head_commit.message, 'docs') || 
         contains(github.event.head_commit.message, 'config') ||
         contains(github.event.head_commit.message, 'tests'))
      uses: peter-evans/enable-pull-request-automerge@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
        merge-method: squash
    
    - name: Notify on failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: "BMAD Autonomous Git Workflow failed on ${{ github.repository }}"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Summary
      run: |
        echo "## BMAD Autonomous Git Workflow Complete" >> $GITHUB_STEP_SUMMARY
        echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: $(git branch --show-current)" >> $GITHUB_STEP_SUMMARY
        echo "- Commits created: $(git rev-list --count HEAD^..HEAD)" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ✅ Success" >> $GITHUB_STEP_SUMMARY
